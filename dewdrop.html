<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Dewdrop - Ocean Blue Edition</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg1:#006aa6;
      --bg2:#003f63;
      --panel:#012a3f;
      --mint:#a8e6cf;
      --mint-2:#6ed3cf;
      --ink:#032538;
      --good:#19c37d;
      --bad:#f25f5c;
      --chip:#0a3a53;
      --txt:#e8fbff;
      --glow:0 20px 50px rgba(0,0,0,.35);
      --ring:#bfeee0;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%; overflow-x: hidden;}
    body{
      font-family: Inter, ui-sans-serif, system-ui, "Segoe UI", Roboto, Helvetica, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% -10%, #0287cc 0%, #015f91 35%, #003a58 100%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      background-attachment: fixed;
      padding:10px;
      overflow-x:hidden;
      font-size:14px;
      min-height: 100vh;
    }

    /* animated ocean gradient sheen */
    body::before{
      content:""; position:fixed; inset:-20%;
      background: conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.06), rgba(255,255,255,0) 35%, rgba(255,255,255,.07) 55%, rgba(255,255,255,0) 85%);
      filter: blur(60px);
      animation: drift 26s linear infinite;
      pointer-events:none; z-index:0;
      opacity:.5;
    }
    @keyframes drift{to{transform:rotate(360deg)}}

    /* floating bubbles */
    .bubbles{ position:fixed; inset:0; overflow:hidden; pointer-events:none; z-index:1; }
    .bubble{
      position:absolute; bottom:-120px; border-radius:999px; opacity:.15;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.2) 40%, rgba(255,255,255,0) 65%);
      filter: blur(0.2px);
      animation: rise var(--dur) linear infinite, sway calc(var(--dur)*.6) ease-in-out infinite;
    }
    @keyframes rise{ to { transform: translateY(-115vh) translateZ(0) } }
    @keyframes sway{ 50% { transform: translateX(18px) } }

    .container{max-width:100%;margin:0 auto;display:flex;flex-direction:column;gap:12px; position:relative; z-index:2;}

    /* top nav */
    .nav{
      display:flex; align-items:center; gap:8px; justify-content:space-between;
      background:rgba(0,33,51,.55);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      padding:8px 10px; border-radius:12px; box-shadow: var(--glow);
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:6px; font-weight:900; letter-spacing:.4px; }
    .logo{
      width:28px;height:28px;border-radius:8px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--mint),var(--mint-2));
      color:var(--ink); font-weight:900; box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    .nav-ctas{display:flex; gap:6px; align-items:center; flex-wrap: wrap;}
    .pill{
      display:inline-flex;align-items:center;gap:4px;
      padding:5px 8px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      font-weight:700;
      font-size: 0.75rem;
    }
    .action{
      display:inline-flex;align-items:center;gap:4px; padding:5px 6px;
      border-radius:8px; border:1px solid rgba(168,230,207,.35); background:rgba(255,255,255,.06);
      cursor:pointer; font-weight:700;
      transition:transform .15s ease, box-shadow .15s ease, background .2s ease;
      font-size: 0.75rem;
      min-height: 32px;
    }
    .action:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.22) }

    header{text-align:center;padding-top:2px}
    h1{
      font-size:1.5rem;
      letter-spacing:.5px;
      background:linear-gradient(90deg,var(--mint),#d7f7e9);
      -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
      filter:drop-shadow(0 6px 18px rgba(0,0,0,.25));
      position:relative;display:inline-block
    }
    h1::after{
      content:"";position:absolute;left:50%;transform:translateX(-50%);
      bottom:-6px;width:80px;height:2px;border-radius:3px;
      background:linear-gradient(90deg,var(--mint),#d7f7e9);
      opacity:.9
    }
    .subtitle{opacity:.92;margin-top:6px; font-weight:600; font-size: 0.8rem; line-height: 1.3; padding: 0 5px;}
    .top-bar{
      display:flex;flex-wrap:wrap;gap:6px;align-items:center;justify-content:center;
      background:rgba(0,33,51,.55);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      padding:8px 10px;border-radius:10px;
      box-shadow:0 10px 28px rgba(0,0,0,.25) inset, 0 6px 16px rgba(0,0,0,.18)
    }
    .top-bar .pill{font-weight:800}

    /* GAME LAYOUT */
    .game{display:grid;grid-template-columns:1fr;gap:12px; align-items:start}

    .panel{
      background:linear-gradient(180deg,rgba(1,33,51,.7),rgba(1,26,40,.7));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      box-shadow:var(--glow);
      transform: translateY(0);
      animation: fadeUp .5s ease both;
    }
    @keyframes fadeUp{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }
    .panel h2{
      font-size:1rem;margin-bottom:8px;color:var(--mint);letter-spacing:.35px; text-transform:uppercase
    }
    .lede{font-size:0.8rem; opacity:.88; margin:-2px 0 8px; line-height:1.45}

    /* inputs */
    .input{display:grid;gap:8px}
    .field label{display:block;margin:2px 0 4px 2px;opacity:.98; font-weight:700; font-size: 0.8rem;}
    .field input, .field select{
      width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(168,230,207,.35);
      background:rgba(255,255,255,.06);color:#fff;font-size:0.85rem;outline:none;
      transition:box-shadow .2s,border-color .2s;text-transform:uppercase;
      min-height: 40px;
    }
    .field input:focus{ border-color:var(--mint); box-shadow:0 0 0 4px rgba(168,230,207,.20) }

    .btn{
      display:flex;align-items:center;justify-content:center;gap:4px;
      padding:8px 10px;border-radius:8px;border:none;cursor:pointer;
      font-weight:900;color:var(--ink);
      background:linear-gradient(90deg,var(--mint),var(--mint-2));
      box-shadow:0 8px 20px rgba(0,0,0,.22);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
      font-size: 0.8rem;
      min-height: 40px;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.30)}
    .btn.secondary{
      background:transparent;color:#e5f9ff;border:1px solid rgba(168,230,207,.35)
    }
    .btn.ghost{
      background:transparent;color:#e5f9ff;border:1px dashed rgba(168,230,207,.35)
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    /* WORD GRID */
    .search{margin-bottom:8px; display:flex; gap:4px; align-items:center}
    .search input{
      width:100%;padding:8px 10px;border-radius:8px;
      border:1px solid rgba(168,230,207,.35);
      background:rgba(255,255,255,.06);color:#fff;outline:none;
      font-size: 0.85rem;
      min-height: 40px;
    }
    .word-grid{
      --cols:3;
      display:grid;
      grid-template-columns:repeat(var(--cols), 1fr);
      grid-auto-rows:minmax(24px,1fr);
      gap:4px;
      min-height: 150px;
    }

    .word-item{
      display:flex; align-items:center; justify-content:center;
      padding:6px 3px; border-radius:5px;
      background:linear-gradient(145deg, rgba(168,230,207,.20), rgba(168,230,207,.08));
      border:1px solid rgba(168,230,207,.35);
      text-align:center; font-weight:800; letter-spacing:.35px; user-select:none;
      cursor:pointer; transition:transform .12s ease, background .2s ease, box-shadow .2s ease;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:0.6rem; line-height:1; text-shadow:0 1px 0 rgba(0,0,0,.25);
      position:relative; isolation:isolate;
      min-height: 28px;
    }
    .word-item:hover{
      background:rgba(168,230,207,.32);
      transform:translateY(-1px);
      box-shadow:0 2px 6px rgba(0,0,0,.18)
    }
    .word-item::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background: radial-gradient(60% 90% at 50% 0%, rgba(255,255,255,.18), transparent 60%);
      opacity:0; transition: opacity .2s ease;
    }
    .word-item:hover::after{ opacity:1 }

    /* bet slip (selected words) */
    .slip{
      display:flex;flex-wrap:wrap;gap:4px;align-items:center;
      padding:6px;border-radius:8px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(168,230,207,.25);
      min-height:36px;
    }
    .chip{
      display:inline-flex;align-items:center;gap:4px;
      padding:4px 6px;border-radius:999px;
      background:linear-gradient(145deg, rgba(168,230,207,.15), rgba(168,230,207,.06));
      border:1px solid rgba(168,230,207,.35);
      font-weight:900;font-size:0.75rem; letter-spacing:.3px;
      box-shadow:0 4px 10px rgba(0,0,0,.18) inset;
      animation: pop .2s ease;
    }
    @keyframes pop{ from{ transform:scale(.92); opacity:0 } to { transform:scale(1); opacity:1 } }
    .chip .x{
      width:14px;height:14px;display:grid;place-items:center;cursor:pointer;
      border-radius:50%;border:1px solid rgba(168,230,207,.4);
      background:rgba(255,255,255,.12);font-size:0.6rem;line-height:1
    }
    .slip-meta{opacity:.9;font-size:0.75rem;margin-left:auto; font-weight:800}

    /* review box */
    .review{
      padding:6px;border-radius:8px;background:rgba(255,255,255,.05);
      border:1px dashed rgba(168,230,207,.35);font-weight:800;letter-spacing:.5px;
      font-size: 0.8rem;
    }

    /* result section */
    .result{
      display:none; text-align:left; padding:14px; border-radius:12px;
      background:linear-gradient(180deg, rgba(1,33,51,.85), rgba(1,26,40,.85));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: var(--glow);
    }
    .result.win{outline:2px solid rgba(25,195,125,.45)}
    .result.lose{outline:2px solid rgba(242,95,92,.45)}
    .result .big{font-size:0.9rem;margin:4px 0 6px; font-weight:900}
    .result-list{margin-top:8px;display:grid;gap:4px}
    .result-item{
      display:grid;grid-template-columns:1fr auto;align-items:center; gap:6px;
      padding:6px;border-radius:6px;
      background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);
      font-weight:800;
      font-size: 0.8rem;
    }
    .tag{padding:2px 4px;border-radius:999px;font-size:0.7rem;font-weight:900}
    .tag.win{background:rgba(25,195,125,.18);border:1px solid rgba(25,195,125,.45);color:#bff3dd}
    .tag.lose{background:rgba(242,95,92,.18);border:1px solid rgba(242,95,92,.45);color:#ffd3d2}
    
    /* Word bag display in results */
    .word-bag-display {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 12px 0;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .letter-chip {
      width: 28px;
      height: 28px;
      display: grid;
      place-items: center;
      border-radius: 6px;
      background: linear-gradient(145deg, rgba(168,230,207,.20), rgba(168,230,207,.08));
      border: 1px solid rgba(168,230,207,.35);
      font-weight: 900;
      font-size: 0.9rem;
    }

    footer{opacity:.8;text-align:center;margin-top:4px; font-size: 0.7rem;}

    /* toast popup */
    .toast{
      position:fixed;left:50%;top:20px;transform:translateX(-50%);
      background:#fff;color:#00324d;border-radius:10px;padding:8px 10px;
      box-shadow:0 10px 26px rgba(0,0,0,.30);z-index:3000;display:none;max-width:90%;
      font-weight:900;
      font-size: 0.8rem;
    }
    .toast.show{display:block;animation:drop .24s ease-out}
    @keyframes drop{from{transform:translate(-50%,-14px);opacity:.0}to{transform:translate(-50%,0);opacity:1}}

    /* modal hint */
    .modal{
      position:fixed;inset:0;display:none;place-items:center;z-index:2600;
      background:rgba(0,0,0,.35);backdrop-filter:blur(2px);
      padding: 10px;
    }
    .modal-card{
      background:#fff;color:#00324d;border-radius:12px;padding:14px;max-width:100%;width:100%;
      box-shadow:0 18px 48px rgba(0,0,0,.35);text-align:center
    }
    .modal .btn{width:auto}

    /* progress ring timer */
    .ring{
      position:relative; width:40px; height:40px; display:grid; place-items:center;
    }
    .ring svg{ transform: rotate(-90deg); width: 40px; height: 40px; }
    .ring .num{ position:absolute; font-size:.6rem; font-weight:900; letter-spacing:.3px }

    /* subtle shimmering highlight for primary CTA */
    .shimmer{
      position:relative; overflow:hidden;
    }
    .shimmer::after{
      content:""; position:absolute; top:0; left:-120%;
      width:60%; height:100%;
      background: linear-gradient(110deg, transparent 0%, rgba(255,255,255,.6) 45%, transparent 100%);
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes shimmer{ 50% { left:160% } }

    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important}
    }
    
    /* Hidden letters bag */
    #letters-bag {
      display: none;
    }
    
    /* Three words button */
    .three-words-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 900;
      color: var(--ink);
      background: linear-gradient(90deg, #ffb347, #ffcc33);
      box-shadow: 0 8px 20px rgba(0,0,0,.22);
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
      margin-top: 8px;
      width: 100%;
      font-size: 0.8rem;
      min-height: 40px;
    }
    .three-words-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(0,0,0,.30);
    }
    
    /* Ads modal */
    .ads-modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 3000;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      padding: 10px;
    }
    .ads-container {
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      max-width: 100%;
      width: 100%;
    }
    .ads-content {
      padding: 16px;
      text-align: center;
      color: #00324d;
    }
    .ads-content h3 {
      margin-bottom: 12px;
      font-weight: 900;
      font-size: 1rem;
    }
    .ads-media {
      width: 100%;
      max-height: 150px;
      object-fit: contain;
      margin-bottom: 12px;
      border-radius: 6px;
    }
    .ads-actions {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    .ads-timer {
      font-weight: 800;
      margin-bottom: 8px;
      color: #006aa6;
      font-size: 0.9rem;
    }
    
    /* User info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      font-size: 0.75rem;
    }
    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    /* Bet History Modal */
    .history-modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 3000;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      padding: 10px;
    }
    .history-container {
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      max-width: 100%;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .history-header {
      background: var(--bg1);
      color: white;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-content {
      padding: 16px;
      color: #00324d;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.8rem;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-date {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .history-words {
      font-weight: 700;
      margin: 4px 0;
    }
    .history-result {
      font-weight: 900;
    }
    .history-result.win {
      color: var(--good);
    }
    .history-result.lose {
      color: var(--bad);
    }
    
    /* Result Screen Styles */
    .result-screen {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 4000;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      padding: 20px;
      overflow-y: auto;
    }
    .result-card {
      background: linear-gradient(180deg, rgba(1,33,51,.95), rgba(1,26,40,.95));
      border-radius: 20px;
      border: 2px solid rgba(255,255,255,0.1);
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      max-width: 800px;
      margin: 0 auto;
      overflow: hidden;
      animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .result-header {
      background: linear-gradient(90deg, var(--bg1), var(--bg2));
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .result-title {
      font-size: 2rem;
      font-weight: 900;
      letter-spacing: 2px;
      background: linear-gradient(90deg, var(--mint), #d7f7e9);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .result-subtitle {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 600;
    }
    .result-body {
      padding: 20px;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .result-section {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .result-section h3 {
      color: var(--mint);
      font-size: 0.9rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .result-value {
      font-size: 1.2rem;
      font-weight: 800;
    }
    .result-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 0.8rem;
      margin-top: 5px;
    }
    .result-badge.win {
      background: rgba(25,195,125,0.2);
      color: #bff3dd;
      border: 1px solid rgba(25,195,125,0.5);
    }
    .result-badge.lose {
      background: rgba(242,95,92,0.2);
      color: #ffd3d2;
      border: 1px solid rgba(242,95,92,0.5);
    }
    .words-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .word-badge {
      padding: 6px 10px;
      background: rgba(168,230,207,0.15);
      border: 1px solid rgba(168,230,207,0.3);
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.8rem;
    }
    .word-badge.valid {
      background: rgba(25,195,125,0.15);
      border-color: rgba(25,195,125,0.4);
    }
    .word-badge.invalid {
      background: rgba(242,95,92,0.15);
      border-color: rgba(242,95,92,0.4);
    }
    .result-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .close-result {
      background: transparent;
      color: var(--txt);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.2s ease;
    }
    .close-result:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Media queries for larger screens */
    @media (min-width: 768px) {
      body {
        padding: 12px;
        font-size: 16px;
      }
      
      .container {
        max-width: 768px;
      }
      
      .game {
        grid-template-columns: 1fr 1fr;
      }
      
      .word-grid {
        --cols: 4;
      }
    }
  </style>
</head>
<body>
  <!-- ambient audio -->
  <audio id="bg-music" loop>
    <source src="dewdrop.mp3" type="audio/mpeg">
  </audio>

  <!-- bubbles -->
  <div class="bubbles" aria-hidden="true" id="bubbles"></div>

  <div class="container" role="application">
    <!-- nav -->
    <div class="nav" aria-label="Top Navigation">
      <div class="brand">
        <div class="logo" style="background: transparent; box-shadow: none;">
          <img src="englabet.png" alt="Englabet Logo" style="width: 28px; height: 28px; border-radius: 8px;">
        </div>
        <div>
          <div style="font-size:0.8rem">Dewdrop</div>
          <small style="opacity:.8;font-weight:700; font-size: 0.6rem;">Ocean Blue Edition</small>
        </div>
      </div>
      <div class="nav-ctas">
        <div class="user-info" id="user-info" style="display: none;">
          <img src="" alt="User Avatar" class="user-avatar" id="user-avatar">
          <span id="user-name"></span>
        </div>
        <div class="pill" title="Session Window"><i class="fa-solid fa-calendar-days"></i> 08:00am – 10:00am</div>
        <button id="music-toggle" class="action" aria-pressed="true" title="Toggle Ocean Ambience">
          <i class="fa-solid fa-music"></i> <span>Sound On</span>
        </button>
        <button id="history-btn" class="action" title="Bet History"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
        <button id="help-btn" class="action" title="How to play" aria-haspopup="dialog"><i class="fa-regular fa-circle-question"></i> Help</button>
        <button id="logout-btn" class="action" title="Logout" style="display: none;"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>

    <header>
      <h1>Dewdrop Challenge</h1>
      <p class="subtitle">Form valid words using the available letters. <strong>Key letter = O</strong>. Win per correct word, lose per incorrect pick. Choose wisely.</p>
    </header>

    <div class="top-bar" role="status" aria-live="polite">
      <div class="pill"><i class="fa-solid fa-wallet"></i> Balance: <span id="balance">₦1000</span></div>
      <div class="pill" style="gap:8px">
        <i class="fa-regular fa-clock"></i>
        <div class="ring" aria-label="Round timer">
          <svg width="40" height="40">
            <circle cx="20" cy="20" r="17" stroke="rgba(255,255,255,.15)" stroke-width="4" fill="none"></circle>
            <circle id="ring-arc" cx="20" cy="20" r="17" stroke="url(#grad)" stroke-width="4" stroke-linecap="round" fill="none" stroke-dasharray="107" stroke-dashoffset="0"/>
            <defs>
              <linearGradient id="grad" x1="0" x2="1">
                <stop offset="0%" stop-color="#a8e6cf"/>
                <stop offset="100%" stop-color="#6ed3cf"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="num" id="timer">02:00:00</div>
        </div>
      </div>
      <div class="pill"><i class="fa-solid fa-key"></i> Key Letter: <b>O</b></div>
    </div>

    <div class="game">
      <!-- Left: input / actions -->
      <section class="panel" aria-labelledby="guess-title">
        <h2 id="guess-title">Your Guess</h2>
        <p class="lede">Enter a word built from the current letter bag. Each correct guess earns your bet; each miss deducts it. Add up to 10 picks per round.</p>

        <div class="input">
          <div class="field">
            <label for="word-input">Enter Word</label>
            <input id="word-input" type="text" placeholder="Enter word..." autocomplete="off" aria-describedby="review-text" />
          </div>

          <div class="review" id="review-box" aria-live="polite">
            Review: <span id="review-text">—</span>
          </div>

          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button id="add-word" class="btn secondary" style="flex:1"><i class="fa-solid fa-plus"></i> Add to Bet Slip</button>
            <button id="clear-slip" class="btn ghost" style="flex:0 0 auto"><i class="fa-regular fa-trash-can"></i> Clear</button>
          </div>

          <div class="field">
            <label>Bet Slip (<span id="slip-count">0</span>/10)</label>
            <div id="bet-slip" class="slip">
              <span style="opacity:.8">No words added yet</span>
            </div>
            <div class="slip-meta" id="slip-meta">Total: ₦0</div>
          </div>

          <div class="field" style="display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center">
            <div>
              <label for="bet-amount">Bet Amount <small>(per word, Min 50)</small></label>
              <input id="bet-amount" type="number" value="50" min="50" inputmode="numeric" />
            </div>
            <button id="submit-btn" class="btn shimmer" title="Place your bet now"><i class="fa-solid fa-coins"></i> Place Bet</button>
          </div>

          <div style="display:flex; gap:6px; flex-wrap:wrap">
            <button id="hint-btn" class="btn secondary"><i class="fa-regular fa-lightbulb"></i> Give Me a Hint</button>
          </div>
          
          <!-- Three Words Button -->
          <button id="three-words-btn" class="three-words-btn">
            <i class="fa-solid fa-3"></i> 3 Words
          </button>
        </div>
      </section>

      <!-- Right: word list -->
      <section class="panel" aria-labelledby="list-title">
        <h2 id="list-title">O-Words</h2>
        <p class="lede">Browse curated "O" starters. Tap to add instantly to your slip.</p>

        <div class="search">
          <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          <input id="search-words" type="text" placeholder="Search words..." aria-label="Search O-words"/>
        </div>

        <!-- Hidden letters bag -->
        <div id="letters-bag" class="pill" style="display:none; margin-bottom:8px; font-weight:900">
          Letters Bag: <span id="bag-letters" style="margin-left:6px; letter-spacing:4px">—</span>
        </div>

        <div id="word-grid" class="word-grid" role="list"><div class="word-item">Loading…</div></div>
        <p style="opacity:.85;margin-top:8px;font-size:.75rem">Tip: Tap a word to add it to your bet slip. Max 10 words.</p>
      </section>
    </div>

    <!-- Result / countdown -->
    <section id="result" class="result" aria-live="polite">
      <h2>Result</h2>
      <div id="result-msg" class="big"></div>
      <div id="word-bag-result" class="word-bag-display"></div>
      <div id="result-list" class="result-list"></div>
    </section>

    <footer><p>From ENGLAGIP powered by AITECH • Dewdrop Challenge © 2025 • Ocean Blue Edition • Crafted for clarity, speed, and thrill.</p></footer>
  </div>

  <!-- Result Screen -->
  <div id="result-screen" class="result-screen">
    <div class="result-card">
      <div class="result-header">
        <div class="result-title">DEWDROP</div>
        <div class="result-subtitle">Game Result</div>
      </div>
      <div class="result-body">
        <div class="result-grid">
          <div class="result-section">
            <h3>Betting Amount</h3>
            <div class="result-value" id="rs-bet-amount">₦0</div>
          </div>
          <div class="result-section">
            <h3>Word Bag</h3>
            <div class="words-list" id="rs-word-bag"></div>
          </div>
          <div class="result-section">
            <h3>Words Played</h3>
            <div class="words-list" id="rs-words-played"></div>
          </div>
          <div class="result-section">
            <h3>Result</h3>
            <div class="result-value" id="rs-result">₦0</div>
            <div class="result-badge" id="rs-badge">Win</div>
          </div>
          <div class="result-section">
            <h3>Date & Time</h3>
            <div class="result-value" id="rs-date-time">-</div>
          </div>
          <div class="result-section">
            <h3>Balance</h3>
            <div class="result-value" id="rs-balance">₦0</div>
          </div>
        </div>
      </div>
      <div class="result-actions">
        <button id="close-result" class="close-result">Close</button>
        <button id="share-result" class="btn">Share Result</button>
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="help-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-card">
      <h3 id="help-title" style="font-weight:900;margin-bottom:8px">How to Play</h3>
      <div style="text-align:left; font-weight:700; line-height:1.35; margin-bottom:12px">
        <ol style="padding-left:18px">
          <li>Form words using only the <b>Letters Bag</b>. Key letter is <b>O</b>.</li>
          <li>Add up to <b>10</b> words to your bet slip.</li>
          <li>Set your <b>Bet Amount</b> (at least ₦50 per word).</li>
          <li>Place your bet before time runs out.</li>
          <li>Each correct word pays +bet; incorrect deducts −bet.</li>
        </ol>
      </div>
      <button id="help-ok" class="btn">Got it</button>
    </div>
  </div>

  <!-- Hint modal -->
  <div id="hint-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="hint-title">
    <div class="modal-card">
      <h3 id="hint-title" style="font-weight:900;margin-bottom:8px">Hint</h3>
      <div id="hint-text" style="font-weight:800;margin-bottom:12px">Hint</div>
      <button id="hint-ok" class="btn">OK</button>
    </div>
  </div>

  <!-- Ads modal -->
  <div id="ads-modal" class="ads-modal">
    <div class="ads-container">
      <div class="ads-content">
        <h3>Watch an Ad for Another Hint</h3>
        <div id="ads-timer" class="ads-timer">Ad will play in 5 seconds</div>
        <div id="ads-media-container"></div>
        <div class="ads-actions">
          <button id="ads-cancel" class="btn secondary">Cancel</button>
          <button id="ads-watch" class="btn">Watch Ad</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bet History Modal -->
  <div id="history-modal" class="history-modal">
    <div class="history-container">
      <div class="history-header">
        <h3 style="margin:0">Bet History</h3>
        <button id="history-close" class="action" style="background:transparent;color:white;border:none;font-size:1.2rem">&times;</button>
      </div>
      <div class="history-content">
        <div id="history-list"></div>
        <div id="no-history" style="text-align:center;padding:20px;opacity:0.7">No bet history yet</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="assertive"></div>

<script>
(() => {
  // ---- STATE ----
  let dict=[], oWords=[], validWords=[], availableLetters=[], keyword="";
  let balance=1000, currency="₦";
  let roundActive=true, timerInterval=null;
  const MAX_SLIP = 10;
  let slip = []; // selected words
  const ROUND_SECONDS = 7200; // 2 hours (7200 seconds)
  let hintUsed = false;
  let betHistory = [];
  let currentUser = null;
  
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDivFTAKUznc1xryU8marfMDZG3v1eYsl8",
    authDomain: "englabet-ad1fe.firebaseapp.com",
    projectId: "englabet-ad1fe",
    storageBucket: "englabet-ad1fe.firebasestorage.app",
    messagingSenderId: "124544822433",
    appId: "1:124544822433:web:c77c980f28c99364c214e0",
    measurementId: "G-JMYYM433R7"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // ---- DOM ----
  const els = {
    balance: document.getElementById('balance'),
    timer: document.getElementById('timer'),
    ringArc: document.getElementById('ring-arc'),
    grid: document.getElementById('word-grid'),
    input: document.getElementById('word-input'),
    bet: document.getElementById('bet-amount'),
    result: document.getElementById('result'),
    resultMsg: document.getElementById('result-msg'),
    resultList: document.getElementById('result-list'),
    wordBagResult: document.getElementById('word-bag-result'),
    search: document.getElementById('search-words'),
    toast: document.getElementById('toast'),
    hintModal: document.getElementById('hint-modal'),
    hintText: document.getElementById('hint-text'),
    reviewText: document.getElementById('review-text'),
    reviewBox: document.getElementById('review-box'),
    betSlip: document.getElementById('bet-slip'),
    slipCount: document.getElementById('slip-count'),
    addWord: document.getElementById('add-word'),
    clearSlip: document.getElementById('clear-slip'),
    bag: document.getElementById('bag-letters'),
    helpBtn: document.getElementById('help-btn'),
    helpModal: document.getElementById('help-modal'),
    helpOk: document.getElementById('help-ok'),
    musicToggle: document.getElementById('music-toggle'),
    bg: document.getElementById('bg-music'),
    slipMeta: document.getElementById('slip-meta'),
    bubbles: document.getElementById('bubbles'),
    threeWordsBtn: document.getElementById('three-words-btn'),
    adsModal: document.getElementById('ads-modal'),
    adsMediaContainer: document.getElementById('ads-media-container'),
    adsTimer: document.getElementById('ads-timer'),
    adsCancel: document.getElementById('ads-cancel'),
    adsWatch: document.getElementById('ads-watch'),
    userInfo: document.getElementById('user-info'),
    userAvatar: document.getElementById('user-avatar'),
    userName: document.getElementById('user-name'),
    logoutBtn: document.getElementById('logout-btn'),
    historyBtn: document.getElementById('history-btn'),
    historyModal: document.getElementById('history-modal'),
    historyList: document.getElementById('history-list'),
    historyClose: document.getElementById('history-close'),
    noHistory: document.getElementById('no-history'),
    resultScreen: document.getElementById('result-screen'),
    rsBetAmount: document.getElementById('rs-bet-amount'),
    rsWordBag: document.getElementById('rs-word-bag'),
    rsWordsPlayed: document.getElementById('rs-words-played'),
    rsResult: document.getElementById('rs-result'),
    rsBadge: document.getElementById('rs-badge'),
    rsDateTime: document.getElementById('rs-date-time'),
    rsBalance: document.getElementById('rs-balance'),
    closeResult: document.getElementById('close-result'),
    shareResult: document.getElementById('share-result')
  };

  // ---- UTIL ----
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const shuffle = a => {for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
  const rand = (n)=>Math.floor(Math.random()*n);
  const randomLetters = (c) => Array.from({length:c},()=> "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random()*26)]).join("");
  const canFormWord = (word, letters) => {
    let bag=[...letters]; for(const ch of word){const k=bag.indexOf(ch); if(k<0) return false; bag.splice(k,1);} return true;
  };
  const formatMoney = (n)=> currency + n.toLocaleString();

  function notify(msg, type="info"){
    els.toast.textContent = msg;
    els.toast.style.color = type==="error" ? "#6a0000" : "#00324d";
    els.toast.classList.add('show');
    setTimeout(()=>els.toast.classList.remove('show'), 1400);
  }

  // progress ring (circumference 2πr with r=17 ≈ 107)
  const RING_LEN = 107;
  function setRing(progress){ // 1.0 -> full, 0 -> empty
    const offset = RING_LEN * (1 - progress);
    els.ringArc.setAttribute('stroke-dasharray', RING_LEN);
    els.ringArc.setAttribute('stroke-dashoffset', offset.toFixed(2));
  }

  function renderGrid(words){
    const list = words.slice(0, 30);
    els.grid.innerHTML = "";
    if(!list.length){
      els.grid.innerHTML = "<div class='word-item'>No words</div>";
      return;
    }
    list.forEach(w=>{
      const d=document.createElement('div');
      d.className='word-item';
      d.setAttribute('role','listitem');
      d.textContent = w.toUpperCase();
      d.title = "Click to add: " + w.toUpperCase();
      d.onclick = ()=>{
        els.input.value = w.toUpperCase();
        updateReview();
        addToSlip(w);
      };
      els.grid.appendChild(d);
    });
  }

  function renderSlip(){
    els.betSlip.innerHTML = "";
    if(slip.length === 0){
      els.betSlip.innerHTML = "<span style='opacity:.8'>No words added yet</span>";
    } else {
      slip.forEach((w,idx)=>{
        const chip = document.createElement('div');
        chip.className = 'chip';
        const span = document.createElement('span');
        span.textContent = w.toUpperCase();
        const x = document.createElement('div');
        x.className = 'x';
        x.setAttribute('title','Remove');
        x.setAttribute('aria-label','Remove '+w.toUpperCase());
        x.innerHTML = '&times;';
        x.onclick = ()=>{ removeFromSlip(idx); };
        chip.appendChild(span);
        chip.appendChild(x);
        els.betSlip.appendChild(chip);
      });
    }
    els.slipCount.textContent = slip.length;
    const bet = Math.max(50, parseInt(els.bet.value||"0",10) || 0);
    els.slipMeta.textContent = "Total: " + formatMoney(bet * slip.length);
  }

  function addToSlip(raw){
    const w = (raw||"").trim().toLowerCase();
    if(!w) return notify("Type a word first");
    if(w.length<3) return notify("Word must be at least 3 letters","error");
    if(!w.includes('o')) return notify("Each word must include O","error");
    if(slip.includes(w)) return notify("Already in your slip");
    if(slip.length>=MAX_SLIP) return notify("Bet slip full (max 10)","error");
    slip.push(w);
    renderSlip();
  }

  function removeFromSlip(index){
    slip.splice(index,1);
    renderSlip();
  }

  function clearSlip(){
    slip = [];
    renderSlip();
  }

  function updateReview(){
    const val = els.input.value.trim().toUpperCase();
    els.reviewText.textContent = val || "—";
  }

  // Calculate remaining time from 8:00 AM to 10:00 AM
  function getRemainingTime() {
    const now = new Date();
    const startTime = new Date(now);
    startTime.setHours(8, 0, 0, 0); // 8:00 AM
    
    const endTime = new Date(now);
    endTime.setHours(10, 0, 0, 0); // 10:00 AM
    
    // If it's after 10:00 AM, set end time to tomorrow's 10:00 AM
    if (now > endTime) {
      endTime.setDate(endTime.getDate() + 1);
    }
    
    // If it's before 8:00 AM, set start time to today's 8:00 AM
    if (now < startTime) {
      startTime.setDate(startTime.getDate() - 1);
    }
    
    const totalDuration = 2 * 60 * 60 * 1000; // 2 hours in milliseconds
    const elapsed = now.getTime() - startTime.getTime();
    const remaining = Math.max(0, totalDuration - elapsed);
    
    return Math.floor(remaining / 1000); // Convert to seconds
  }

  function startTimer(){
    // Get remaining time from 8:00 AM to 10:00 AM
    let t = getRemainingTime();
    
    // Save the current time to localStorage for persistence
    localStorage.setItem('dewdrop_timer_start', Date.now().toString());
    localStorage.setItem('dewdrop_timer_remaining', t.toString());
    
    clearInterval(timerInterval);
    
    function tick(){
      // Update time from localStorage to handle page refreshes
      const savedStart = parseInt(localStorage.getItem('dewdrop_timer_start') || "0", 10);
      const savedRemaining = parseInt(localStorage.getItem('dewdrop_timer_remaining') || "0", 10);
      
      if (savedStart > 0 && savedRemaining > 0) {
        const elapsedSinceSave = Math.floor((Date.now() - savedStart) / 1000);
        t = Math.max(0, savedRemaining - elapsedSinceSave);
        
        // Update localStorage with current values
        localStorage.setItem('dewdrop_timer_start', Date.now().toString());
        localStorage.setItem('dewdrop_timer_remaining', t.toString());
      }
      
      const h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=t%60;
      els.timer.textContent=`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      setRing(t/ROUND_SECONDS);
      
      if(t<=0){ 
        clearInterval(timerInterval); 
        roundActive=false; 
        notify("⏱️ Time up!", "error"); 
        
        // Clear localStorage when timer ends
        localStorage.removeItem('dewdrop_timer_start');
        localStorage.removeItem('dewdrop_timer_remaining');
      }
    }
    
    tick(); 
    timerInterval=setInterval(tick,1000);
  }

  function setLettersBag(letters){
    els.bag.textContent = letters.map(x=>x.toUpperCase()).join(" ");
  }
  
  function displayWordBag(letters) {
    els.wordBagResult.innerHTML = "";
    letters.forEach(letter => {
      const chip = document.createElement('div');
      chip.className = 'letter-chip';
      chip.textContent = letter.toUpperCase();
      els.wordBagResult.appendChild(chip);
    });
  }

  function startNewRound(){
    els.result.style.display="none";
    els.result.classList.remove('win','lose');
    roundActive=true;
    hintUsed = false;
    els.input.value="";
    updateReview();
    clearSlip();

    // keyword from O words;  ensure presence of 'o'
    keyword = (oWords[rand(oWords.length)] || "oil");
    const extra = randomLetters(rand(2)+2);
    availableLetters = shuffle((keyword+extra).split(""));
    validWords = dict.filter(w => w.length>=3 && canFormWord(w, availableLetters));

    // UI
    setLettersBag(availableLetters);
    renderGrid(shuffle(oWords).slice(0,30));
    startTimer();
  }

  // Save bet history to Firestore under the user's document
  async function saveBetToFirestore(result) {
    if (!currentUser) {
      console.error("No user logged in");
      return;
    }
    
    try {
      const betData = {
        date: new Date().toISOString(),
        words: slip,
        betAmount: parseInt(els.bet.value, 10),
        result: result,
        balance: balance,
        wordBag: availableLetters,
        validWords: validWords,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Save to user's bet_history subcollection
      await db.collection('users').doc(currentUser.uid)
        .collection('bet_history').add(betData);
        
      console.log("Bet saved to user's Firestore history");
      return betData;
    } catch (error) {
      console.error("Error saving bet to Firestore:", error);
      return null;
    }
  }

  // Load bet history from Firestore
  async function loadBetHistory() {
    if (!currentUser) {
      console.error("No user logged in");
      return [];
    }
    
    try {
      const snapshot = await db.collection('users').doc(currentUser.uid)
        .collection('bet_history')
        .orderBy('timestamp', 'desc')
        .limit(20)
        .get();
      
      const history = [];
      snapshot.forEach(doc => {
        history.push({ id: doc.id, ...doc.data() });
      });
      
      return history;
    } catch (error) {
      console.error("Error loading bet history:", error);
      return [];
    }
  }

  // Display bet history in modal
  async function showBetHistory() {
    const history = await loadBetHistory();
    els.historyList.innerHTML = '';
    
    if (history.length === 0) {
      els.noHistory.style.display = 'block';
    } else {
      els.noHistory.style.display = 'none';
      history.forEach(bet => {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        const left = document.createElement('div');
        const date = document.createElement('div');
        date.className = 'history-date';
        date.textContent = new Date(bet.date).toLocaleString();
        
        const words = document.createElement('div');
        words.className = 'history-words';
        words.textContent = bet.words.map(w => w.toUpperCase()).join(', ');
        
        left.appendChild(date);
        left.appendChild(words);
        
        const right = document.createElement('div');
        const result = document.createElement('div');
        result.className = `history-result ${bet.result >= 0 ? 'win' : 'lose'}`;
        result.textContent = (bet.result >= 0 ? '+' : '') + formatMoney(bet.result);
        
        right.appendChild(result);
        
        item.appendChild(left);
        item.appendChild(right);
        els.historyList.appendChild(item);
      });
    }
    
    els.historyModal.style.display = 'grid';
  }

  // Save words formed from letters bag to Firestore under the user's document
  async function saveWordsToFirestore() {
    if (!currentUser) {
      console.error("No user logged in");
      return;
    }
    
    try {
      const wordsData = {
        letters: availableLetters,
        validWords: validWords,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      // Save to user's word_combinations subcollection
      await db.collection('users').doc(currentUser.uid)
        .collection('word_combinations').add(wordsData);
        
      console.log("Words saved to user's Firestore");
    } catch (error) {
      console.error("Error saving words to Firestore:", error);
    }
  }

  // Show result screen
  function showResultScreen(resultData) {
    // Update result screen data
    els.rsBetAmount.textContent = formatMoney(resultData.betAmount);
    
    // Display word bag
    els.rsWordBag.innerHTML = '';
    resultData.wordBag.forEach(letter => {
      const chip = document.createElement('div');
      chip.className = 'letter-chip';
      chip.textContent = letter.toUpperCase();
      els.rsWordBag.appendChild(chip);
    });
    
    // Display words played with validation status
    els.rsWordsPlayed.innerHTML = '';
    resultData.words.forEach(word => {
      const badge = document.createElement('div');
      const isValid = resultData.validWords.includes(word);
      badge.className = `word-badge ${isValid ? 'valid' : 'invalid'}`;
      badge.textContent = word.toUpperCase();
      els.rsWordsPlayed.appendChild(badge);
    });
    
    // Display result
    els.rsResult.textContent = (resultData.result >= 0 ? '+' : '') + formatMoney(resultData.result);
    
    // Update badge
    els.rsBadge.textContent = resultData.result >= 0 ? 'WIN' : 'LOSE';
    els.rsBadge.className = `result-badge ${resultData.result >= 0 ? 'win' : 'lose'}`;
    
    // Display date and time
    els.rsDateTime.textContent = new Date(resultData.date).toLocaleString();
    
    // Display balance
    els.rsBalance.textContent = formatMoney(resultData.balance);
    
    // Show result screen
    els.resultScreen.style.display = 'block';
  }

  // Load ads from Firestore
  async function loadAds() {
    try {
      const snapshot = await db.collection('ads').get();
      const ads = [];
      snapshot.forEach(doc => {
        ads.push(doc.data());
      });
      return ads;
    } catch (error) {
      console.error("Error loading ads:", error);
      return [];
    }
  }

  // Show ad for hint
  async function showAdForHint() {
    const ads = await loadAds();
    if (ads.length === 0) {
      notify("No ads available at the moment", "error");
      return false;
    }
    
    const randomAd = ads[Math.floor(Math.random() * ads.length)];
    els.adsMediaContainer.innerHTML = '';
    
    // Create appropriate media element based on file type
    let mediaElement;
    if (randomAd.url.endsWith('.mp4')) {
      mediaElement = document.createElement('video');
      mediaElement.controls = true;
      mediaElement.autoplay = true;
      mediaElement.style.width = '100%';
    } else if (randomAd.url.endsWith('.mp3')) {
      mediaElement = document.createElement('audio');
      mediaElement.controls = true;
      mediaElement.autoplay = true;
    } else if (randomAd.url.endsWith('.png') || randomAd.url.endsWith('.jpg') || randomAd.url.endsWith('.jpeg')) {
      mediaElement = document.createElement('img');
      mediaElement.style.maxWidth = '100%';
      mediaElement.style.maxHeight = '150px';
    }
    
    mediaElement.src = randomAd.url;
    els.adsMediaContainer.appendChild(mediaElement);
    
    // Show ad modal
    els.adsModal.style.display = 'grid';
    
    // Countdown timer
    let countdown = 5;
    const countdownInterval = setInterval(() => {
      els.adsTimer.textContent = `Ad will play in ${countdown} seconds`;
      countdown--;
      
      if (countdown < 0) {
        clearInterval(countdownInterval);
        els.adsWatch.click();
      }
    }, 1000);
    
    // Return a promise that resolves when the ad is watched
    return new Promise((resolve) => {
      els.adsWatch.onclick = () => {
        clearInterval(countdownInterval);
        els.adsModal.style.display = 'none';
        resolve(true);
      };
      
      els.adsCancel.onclick = () => {
        clearInterval(countdownInterval);
        els.adsModal.style.display = 'none';
        resolve(false);
      };
    });
  }

  // Check authentication state
  function checkAuthState() {
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        // Show user info
        els.userInfo.style.display = 'flex';
        els.userName.textContent = user.displayName || user.email;
        els.userAvatar.src = user.photoURL || 'https://via.placeholder.com/24';
        els.logoutBtn.style.display = 'block';
        
        // Load user balance from Firestore
        try {
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            balance = userData.balance || 1000;
            els.balance.textContent = currency + balance;
          }
        } catch (error) {
          console.error("Error loading user data:", error);
        }
      } else {
        // No user is signed in, redirect to login
        window.location.href = 'login.html';
      }
    });
  }

  // Logout function
  function logout() {
    auth.signOut().then(() => {
      window.location.href = 'login.html';
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  }

  // ---- EVENTS ----
  els.input.addEventListener('input', updateReview);
  els.addWord.addEventListener('click', ()=>{ addToSlip(els.input.value); });
  els.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); addToSlip(els.input.value); }});
  els.clearSlip.addEventListener('click', clearSlip);
  els.bet.addEventListener('input', renderSlip);
  els.logoutBtn.addEventListener('click', logout);
  els.historyBtn.addEventListener('click', showBetHistory);
  els.historyClose.addEventListener('click', () => {
    els.historyModal.style.display = 'none';
  });
  
  // Three Words Button
  els.threeWordsBtn.addEventListener('click', () => {
    window.location.href = 'dewdrop3.html';
  });
  
  // Result Screen Events
  els.closeResult.addEventListener('click', () => {
    els.resultScreen.style.display = 'none';
  });
  
  els.shareResult.addEventListener('click', () => {
    // Simple share functionality
    const shareText = `I just played Dewdrop Challenge and ${els.rsBadge.textContent === 'WIN' ? 'won' : 'lost'} ${els.rsResult.textContent}! Can you beat my score?`;
    if (navigator.share) {
      navigator.share({
        title: 'Dewdrop Challenge Result',
        text: shareText,
        url: window.location.href
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(shareText).then(() => {
        notify("Result copied to clipboard!");
      });
    }
  });

  document.getElementById('submit-btn').addEventListener('click', async ()=>{
    if(!roundActive){
      notify("Round finished. Start a new one.", "error");
      els.result.scrollIntoView({behavior:"smooth",block:"center"});
      return;
    }

    if(slip.length===0 && els.input.value.trim()){
      addToSlip(els.input.value);
    }
    if(slip.length===0){ notify("Add at least one word to bet on","error"); return; }

    const bet = parseInt(els.bet.value,10);
    if(isNaN(bet) || bet<50){ notify("Minimum bet is ₦50", "error"); return; }
    const totalCost = bet * slip.length;
    if(totalCost>balance){ notify("Insufficient balance for all words", "error"); return; }

    els.result.style.display="block";
    els.result.classList.remove('win','lose');
    els.resultMsg.innerHTML = `⏳ Checking <b>${slip.length}</b> word(s)...`;
    els.resultList.innerHTML = "";
    displayWordBag(availableLetters);
    els.result.scrollIntoView({behavior:"smooth",block:"start"});

    roundActive=false;

    // Evaluate each word
    let net = 0;
    slip.forEach(w=>{
      const ok = validWords.includes(w);
      const item = document.createElement('div');
      item.className = 'result-item';
      const left = document.createElement('div');
      left.textContent = w.toUpperCase();
      const right = document.createElement('div');
      const tag = document.createElement('span');
      tag.className = 'tag ' + (ok?'win':'lose');
      tag.textContent = (ok ? '+' : '−') + currency + bet;
      right.appendChild(tag);
      item.appendChild(left);
      item.appendChild(right);
      els.resultList.appendChild(item);
      net += ok ? bet : -bet;
    });

    balance += net;
    els.balance.textContent = currency + balance;
    
    // Update user balance in Firestore
    if (currentUser) {
      try {
        await db.collection('users').doc(currentUser.uid).update({
          balance: balance
        });
      } catch (error) {
        console.error("Error updating user balance:", error);
      }
    }
    
    // Save to Firestore and get result data
    const resultData = await saveBetToFirestore(net);
    await saveWordsToFirestore();

    // Custom congratulations based on result
    if (net > 0) {
      els.result.classList.add('win');
      if (net >= 500) {
        els.resultMsg.innerHTML = `🎉 AMAZING! You won <b>+${currency}${net}</b>! You're a word master!`;
      } else if (net >= 200) {
        els.resultMsg.innerHTML = `🎉 GREAT JOB! You won <b>+${currency}${net}</b>! Keep it up!`;
      } else {
        els.resultMsg.innerHTML = `🎉 Well done! You netted <b>+${currency}${net}</b> on ${slip.length} word(s).`;
      }
      notify("✅ You won!");
    } else if (net < 0) {
      els.result.classList.add('lose');
      if (net <= -500) {
        els.resultMsg.innerHTML = `😢 Tough luck! You lost <b>${currency}${Math.abs(net)}</b>. Better luck next time!`;
      } else if (net <= -200) {
        els.resultMsg.innerHTML = `😕 Unfortunate! You lost <b>${currency}${Math.abs(net)}</b>. Try again!`;
      } else {
        els.resultMsg.innerHTML = `❌ Done! You lost <b>${currency}${Math.abs(net)}</b> on ${slip.length} word(s).`;
      }
      notify("✖️ Better luck next time");
    } else {
      els.resultMsg.innerHTML = `➖ Break even! No gain, no loss on ${slip.length} word(s).`;
      notify("➖ Break even!");
    }
    
    // Show result screen
    if (resultData) {
      showResultScreen(resultData);
    }
    
    // Clear input field and start new round immediately
    els.input.value = "";
    updateReview();
    startNewRound();
  });

  // search
  let tId=null;
  els.search.addEventListener('input', (e)=>{
    const q=e.target.value.toLowerCase();
    clearTimeout(tId);
    tId=setTimeout(()=>{
      const filtered = oWords.filter(w => w.startsWith('o') && w.includes(q) && w.length>=3);
      renderGrid(filtered.slice(0,30));
    },120);
  });

  // help
  els.helpBtn.addEventListener('click', ()=> els.helpModal.style.display='grid');
  els.helpOk.addEventListener('click', ()=> els.helpModal.style.display='none');

  // hint
  document.getElementById('hint-btn').addEventListener('click', async ()=>{
    if (!keyword) return;
    
    if (hintUsed) {
      const watched = await showAdForHint();
      if (!watched) return;
    }
    
    const hintLetter = keyword[rand(keyword.length)].toUpperCase();
    els.hintText.innerHTML = `💡 The keyword contains the letter <b>${hintLetter}</b>`;
    els.hintModal.style.display='grid';
    hintUsed = true;
  });
  document.getElementById('hint-ok').addEventListener('click', ()=> els.hintModal.style.display='none');

  // music toggle
  function syncMusicUI(){
    const on = !els.bg.paused;
    els.musicToggle.setAttribute('aria-pressed', String(on));
    els.musicToggle.querySelector('span').textContent = on ? "Sound On" : "Sound Off";
    els.musicToggle.querySelector('i').className = on ? "fa-solid fa-music" : "fa-solid fa-music-slash";
  }
  els.musicToggle.addEventListener('click', async ()=>{
    if(els.bg.paused){ try{ await els.bg.play(); }catch(e){} } else { els.bg.pause(); }
    syncMusicUI();
  });

  // bubbles
  function spawnBubbles(){
    const n = 18;
    for(let i=0;i<n;i++){
      const b = document.createElement('div');
      b.className='bubble';
      const size = 10 + Math.random()*26;
      b.style.width = size+'px';
      b.style.height = size+'px';
      b.style.left = (Math.random()*100)+'%';
      b.style.setProperty('--dur', (12 + Math.random()*18) + 's');
      b.style.animationDelay = (-Math.random()*20)+'s';
      els.bubbles.appendChild(b);
    }
  }

  // dictionary
  async function loadDict(){
    const res = await fetch("https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt");
    const text = await res.text();
    return text.split("\n").map(x=>x.trim().toLowerCase());
  }

  (async function init(){
    // Check authentication
    checkAuthState();
    
    // restore balance
    const saved = parseInt(localStorage.getItem('dewdrop_balance')||"0",10);
    if(!isNaN(saved) && saved>0){ balance = saved; }
    els.balance.textContent = currency + balance;

    notify("Loading dictionary…");
    try{
      dict = await loadDict();
      oWords = dict.filter(w=>w.startsWith('o') && w.length>=3);
      notify("Ready!");
    }catch(e){
      notify("Failed to load dictionary","error");
      // fallback minimal dictionary if fetch fails
      dict = ["oil","oils","soil","solo","soon","soonest","stone","one","ones","nose","son","sonic","ionic","icon","icons"];
      oWords = dict.filter(w=>w.startsWith('o') && w.length>=3);
    }

    // start audio automatically on init (attempt autoplay)
    try{ 
      await els.bg.play(); 
      syncMusicUI(); // sync UI to reflect "on" state
    } catch(e) {
      console.warn("Autoplay failed, user interaction may be required.");
      syncMusicUI(); // still sync UI in case it was paused
    }

    // visuals
    spawnBubbles();

    // kick off round
    startNewRound();
    updateReview();
  })();
})();
</script>
</body>
</html>